name: G2B Auto Collector

on:
  schedule:
    - cron: "0 23 * * *"  # UTC 23:00 = KST 08:00
    - cron: "0 5 * * *"   # UTC 05:00 = KST 14:00
    - cron: "0 11 * * *"  # UTC 11:00 = KST 20:00
  workflow_dispatch:
    inputs:
      skip_connection_test:
        description: "ì—°ê²° í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°"
        required: false
        default: false
        type: boolean
      force_api_reset:
        description: "API í˜¸ì¶œ ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹ (ì£¼ì˜)"
        required: false
        default: false
        type: boolean
      reset_progress:
        description: "ì§„í–‰ ìœ„ì¹˜ ë¦¬ì…‹ (ì‹œì‘ ì—°ë„-ì›” ì…ë ¥, ì˜ˆ: 2016-02 / ë¹„ì›Œë‘ë©´ ë¦¬ì…‹ ì•ˆ í•¨)"
        required: false
        default: ""
        type: string

jobs:
  g2b-job:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # ë¬´í•œ ë£¨í”„ ë°©ì§€

    env:
      # GitHub Secretsì—ì„œ ê°€ì ¸ì˜´
      API_KEY: ${{ secrets.API_KEY }}
      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      GDRIVE_PROGRESS_FILE_ID: ${{ secrets.GDRIVE_PROGRESS_FILE_ID }}
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # íŒŒì´ì¬ ê²½ë¡œ ì„¤ì • (ë§¤ìš° ì¤‘ìš”: utils ëª¨ë“ˆ ì¸ì‹ìš©)
      PYTHONPATH: ${{ github.workspace }}
      TZ: Asia/Seoul

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ğŸ—„ï¸ DB í…Œì´ë¸” ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±, ìˆìœ¼ë©´ ë¬´ì‹œ)
      - name: Create DB Table
        run: |
          python -c "
          from utils.db import create_table
          create_table()
          print('âœ… contracts í…Œì´ë¸” ì¤€ë¹„ ì™„ë£Œ')
          "

      # ğŸ” ë³´ì•ˆ í‚¤ ìƒì„± (Base64 ë””ì½”ë”©)
      - name: Create service_account.json
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS }}" | base64 -d > service_account.json
          if [ -s "service_account.json" ]; then
            echo "âœ… service_account.json ìƒì„± ì™„ë£Œ"
          else
            echo "âŒ service_account.json ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      # ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸ (ë“œë¼ì´ë¸Œ & ìŠ¬ë™ & G2B API)
      - name: Connection Tests
        if: ${{ !inputs.skip_connection_test }}
        run: |
          echo "ğŸ§ª ì‹œìŠ¤í…œ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          python -c "
          import sys
          import os
          from utils.drive import test_drive_connection
          from utils.g2b_client import G2BClient

          # 1. Google Drive ì—°ê²° í…ŒìŠ¤íŠ¸
          print('ğŸ“‚ Google Drive ì—°ê²° í…ŒìŠ¤íŠ¸...')
          try:
              if not test_drive_connection():
                  print('âŒ Google Drive ì—°ê²° ì‹¤íŒ¨')
                  sys.exit(1)
              print('âœ… Google Drive ì—°ê²° ì„±ê³µ')
          except Exception as e:
              print(f'âŒ Google Drive í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}')
              sys.exit(1)

          # 2. G2B API ì—°ê²° í…ŒìŠ¤íŠ¸
          print('ğŸ“¡ G2B API ì—°ê²° í…ŒìŠ¤íŠ¸...')
          try:
              api_key = os.getenv('API_KEY')
              if not api_key:
                  print('âš ï¸ API_KEYê°€ ì—†ì–´ G2B í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€')
              else:
                  client = G2BClient(api_key)
                  if not client.test_connection():
                      print('âŒ G2B API ì—°ê²° ì‹¤íŒ¨')
                      sys.exit(1)
                  print('âœ… G2B API ì—°ê²° ì„±ê³µ')
          except Exception as e:
              print(f'âŒ G2B API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}')
              sys.exit(1)

          print('âœ… ëª¨ë“  ì—°ê²° í…ŒìŠ¤íŠ¸ í†µê³¼')
          "
        continue-on-error: false

      # ğŸ“¥ Driveì—ì„œ ìƒíƒœ íŒŒì¼(progress.json) ë‹¤ìš´ë¡œë“œ
      - name: Download progress.json
        timeout-minutes: 5
        run: |
          python collectors/g2b/download_progress.py
          if [ -f "progress.json" ]; then
            echo "âœ… progress.json ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "âŒ progress.json ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì´ˆê¸° ì‹¤í–‰ì´ë©´ ë¡œì»¬ íŒŒì¼ ì‚¬ìš©)"
            # ì‹¤íŒ¨í•´ë„ ë¡œì»¬ íŒŒì¼ì´ ìˆìœ¼ë©´ ê³„ì† ì§„í–‰í•˜ë„ë¡ exit 1 ì œê±° (ì„ íƒì‚¬í•­)
          fi

      # ğŸ”„ (ì„ íƒ) API ì¹´ìš´íŠ¸ ê°•ì œ ë¦¬ì…‹
      - name: Force Reset API Count
        if: ${{ inputs.force_api_reset }}
        run: |
          python -c "
          import json
          try:
              with open('progress.json', 'r') as f:
                  data = json.load(f)
              data['daily_api_calls'] = 0
              with open('progress.json', 'w') as f:
                  json.dump(data, f)
              print('ğŸ”„ API ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë¨')
          except Exception as e:
              print(f'âš  ë¦¬ì…‹ ì‹¤íŒ¨: {e}')
          "

      # ğŸ”„ (ì„ íƒ) ìˆ˜ì§‘ ì‹œì‘ ìœ„ì¹˜ ë¦¬ì…‹ (ì˜ˆ: "2016-02")
      - name: Reset Progress Position
        if: ${{ inputs.reset_progress != '' }}
        run: |
          python -c "
          import json, sys

          raw = '${{ inputs.reset_progress }}'.strip()
          try:
              year_str, month_str = raw.split('-')
              year = int(year_str)
              month = int(month_str)
              assert 2000 <= year <= 2030 and 1 <= month <= 12
          except Exception:
              print(f'âŒ ì˜ëª»ëœ í˜•ì‹: {raw!r}. ì˜ˆì‹œ: 2016-02')
              sys.exit(1)

          # ê¸°ì¡´ total_collected ë³´ì¡´ (ë¦¬ì…‹í•´ë„ ëˆ„ì  ê±´ìˆ˜ëŠ” ìœ ì§€)
          try:
              with open('progress.json', 'r', encoding='utf-8') as f:
                  existing = json.load(f)
              prev_total = existing.get('total_collected', 0)
          except Exception:
              prev_total = 0

          new_progress = {
              'current_job': 'ë¬¼í’ˆ',
              'current_year': year,
              'current_month': month,
              'daily_api_calls': 0,
              'total_collected': prev_total,
              'last_run_date': ''
          }
          with open('progress.json', 'w', encoding='utf-8') as f:
              json.dump(new_progress, f, ensure_ascii=False, indent=2)
          print(f'ğŸ”„ ì§„í–‰ ìœ„ì¹˜ ë¦¬ì…‹ ì™„ë£Œ: ë¬¼í’ˆ {year}ë…„ {month}ì›”ë¶€í„° ì‹œì‘')
          "

          # Driveì— ì¦‰ì‹œ ì—…ë¡œë“œ
          python collectors/g2b/upload_progress.py
          echo "âœ… ë¦¬ì…‹ëœ progress.jsonì„ Driveì— ì—…ë¡œë“œ ì™„ë£Œ"

      # ğŸš€ ë©”ì¸ ìˆ˜ì§‘ê¸° ì‹¤í–‰ (ë¡œê·¸ íŒŒì¼ì— ê¸°ë¡í•˜ë©° ì‹¤í–‰)
      - name: Run G2B Collector
        id: run_collector
        timeout-minutes: 110
        run: |
          echo "ğŸš€ G2B ìˆ˜ì§‘ ì‹œì‘..."
          echo "â° ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"

          # í‘œì¤€ ì¶œë ¥ì„ í™”ë©´ê³¼ íŒŒì¼(collection.log)ì— ë™ì‹œì— ê¸°ë¡
          if python collectors/g2b/collect_all.py 2>&1 | tee collection.log; then
            echo "âœ… ìˆ˜ì§‘ ì™„ë£Œ"
            echo "collector_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ìˆ˜ì§‘ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $?)"
            echo "collector_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "â° ì¢…ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        continue-on-error: false

      # ğŸ“¤ ìƒíƒœ íŒŒì¼(progress.json) Driveì— ì—…ë¡œë“œ (ì‹¤íŒ¨í•´ë„ ì‹¤í–‰)
      - name: Upload progress.json
        if: always()
        run: |
          python collectors/g2b/upload_progress.py

      # ğŸš¨ ì‹¤íŒ¨ ì‹œ ìƒì„¸ Slack ì•Œë¦¼
      - name: Notify Failure
        if: failure()
        run: |
          python -c "
          from utils.slack import send_slack_message
          import os
          from datetime import datetime

          run_url = 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S KST')

          # íƒ€ì„ì•„ì›ƒ ì—¬ë¶€ íŒë‹¨ (collection.logì— ìˆ˜ì§‘ ë°ì´í„°ê°€ ìˆìœ¼ë©´ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ê°„ì£¼)
          is_timeout = False
          insert_summary = ''
          try:
              with open('collection.log', 'r', encoding='utf-8') as f:
                  content = f.read()
                  if 'DB insert' in content or 'insert' in content.lower():
                      is_timeout = True
                      # ë§ˆì§€ë§‰ insert ê±´ìˆ˜ ì¶”ì¶œ
                      lines = content.splitlines()
                      for line in reversed(lines):
                          if 'insert' in line.lower():
                              insert_summary = line.strip()[:100]
                              break
          except:
              pass

          if is_timeout:
              message = f'â° íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¢…ë£Œ (ì •ìƒ)\n\nìˆ˜ì§‘ ì¤‘ 110ë¶„ ì œí•œ ë„ë‹¬ â€” ë‹¤ìŒ ì‹¤í–‰ì—ì„œ ì´ì–´ì„œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.\nâ° ì‹œê°„: {timestamp}\nğŸ”— ë¡œê·¸: {run_url}'
          else:
              message = f'ğŸš¨ GitHub Actions ì‹¤íŒ¨\n\nâ° ì‹œê°„: {timestamp}\nğŸ”— ë¡œê·¸: {run_url}\n\në¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'

          send_slack_message(message)
          " || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        continue-on-error: true

      # ğŸ“‚ ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì €ì¥ (ë””ë²„ê¹…ìš©)
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: |
            collection.log
            progress.json
          retention-days: 5
          # âš ï¸ ì£¼ì˜: service_account.jsonì€ ì ˆëŒ€ ì˜¬ë¦¬ì§€ ì•ŠìŒ!

      # ğŸ§¹ ë³´ì•ˆ íŒŒì¼ ì‚­ì œ
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f service_account.json
          echo "ğŸ§¹ ë³´ì•ˆ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
